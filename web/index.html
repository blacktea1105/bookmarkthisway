<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<script type="text/javascript" src="./libs/google-drive.js"></script>

<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>

<script type="text/javascript" src="./libs/jtree/jstree.min.js"></script>
<script type="text/javascript" src="./libs/tree.js"></script>
<script type="text/javascript" src="./libs/jquery-ui-utils.js"></script>

<script type="text/javascript">
    var CLIENT_ID = "460606321746-60eoev9jsf2pqp1t37otikutqcleudmb.apps.googleusercontent.com";
    var TEST_CLIENT_ID = "460606321746-6vebbhq1ouilldot0j5khk9cinkua6cp.apps.googleusercontent.com";
    var SCOPES = "https://www.googleapis.com/auth/drive";

    // var g_GoogleDrive = new GoogleDrive(CLIENT_ID, SCOPES);
    var g_GoogleDrive = new GoogleDrive(TEST_CLIENT_ID, SCOPES);
    var g_FolderTree, contentTree;

    // js init
    $(function() {
        // trees
        g_FolderTree = createFolderTree();
        g_ContentTree = new ContentTree("contentTree");

        // root folder select
        $("#pageSelect").on("change", function (e) {
           refreshRootFolder(this.value);
        });
    });
    
    /**
     * [createFolderTree description]
     * @return {FolderTree} [description]
     */
    function createFolderTree() {
        result = new FolderTree("folderTree", createContextMenuCallback());

        // rename event
        result.$tree.bind("rename_node.jstree", function(e, data) {
            g_GoogleDrive.rename(data.node.id, data.text, function(resp) {
                if (!resp.error) {

                } else {  // drive rename failed
                    JqUi.popupMessage("error", "Rename failed!");
                    refreshRootFolder($("#pageSelect").value);
                }
            });
        });

        // select event
        result.$tree.on("select_node.jstree", function (e, data) {
            refreshContentTree(data.node.id);
        });

        // deselect event
        result.$tree.on("deselect_all.jstree", function (e, data) {
            if (g_ContentTree) {
                g_ContentTree.clear();
            }
        });

        return result;
    }

    /**
     * [createContextMenuCallback description]
     * @return {Object} call back of context menu of tree.
     */
    function createContextMenuCallback() {
        return {
            // add link
            "addLink": function(node) {
               JqUi.popupBookmarkData(
                {
                    "window": {"title": "Add Link", "commitBtnLabel": "Add", "cancelBtnLabel": "Cancel"}
                },
                function(bookmark) {
                    alert("title: " + bookmark.title + ", url: " + bookmark.url + ", des: " + bookmark.description);
                    return false;
               });
            },

            // add folder
            "addFolder": function(node) {
                g_GoogleDrive.createFolder(node.id, "New Folder", function(resp) {
                    if (!resp.error) {
                        var token = g_FolderTree.token;
                        var newFolder = {
                            "id": resp.id,
                            "text": resp.title,
                            "type": TREE_NODE_TYPE_FOLDER,
                        };

                        g_FolderTree.appendNode(node.id, newFolder, token);  // append to folder tree

                        g_FolderTree.jstree.deselect_all();
                        g_FolderTree.jstree.select_node(newFolder);

                        g_FolderTree.jstree.edit(newFolder.id);  // edit(rename)

                    } else {  // drive rename failed
                        JqUi.popupMessage("error", "Add new folder failed!");
                        refreshRootFolder($("#pageSelect").value);
                    }
                });
            },

            // rename folder
            "renameFolder": function(node) {
                g_FolderTree.jstree.edit(node.id);
            },

            // delete folder
            "deleteFolder": function(node) {
                var trashFile = function() {
                    g_GoogleDrive.trashFile(node.id, function(resp) {
                        if (!resp.error) {
                            g_FolderTree.jstree.delete_node(node);
                            g_FolderTree.jstree.deselect_all();

                        } else {  // drive rename failed
                            JqUi.popupMessage("error", "Rename failed!");
                            refreshRootFolder($("#pageSelect").value);
                        }
                    });
                }

                var buttons = {
                    "Delete": function() {
                        trashFile();
                        return true;
                    },
                    "Cancel": function() {
                        return true;
                    },
                };
                JqUi.popupWithButtons("Delete Folder", "Are you sure delete this folder: " + node.text, buttons);
            }
        };
    }

    /**
     * [changeRootFolder description]
     * @param  {String} rootId root ID form google drive folder.
     */
    function refreshRootFolder(rootId) {
         // clear all node
        g_FolderTree.clear();
        g_ContentTree.clear();
        g_ContentTree.generateToken();  // prevrnt old tree UI mainpulate
        var curToken = g_FolderTree.generateToken();

        // append root node
        var rootText = $(this).find("option:selected").text();
        var rootNode = {"id": rootId, "parent": "#", "text": rootText, "type": TREE_NODE_TYPE_ROOT_FOLDER};
        g_FolderTree.appendNode("#", rootNode, curToken);
        g_FolderTree.jstree.select_node(rootNode);

        // append children node
        g_GoogleDrive.getAllFoldersByRoot(rootId, function(item) {
            var parentId = item.parents[0].id;
            var node = {
                "id": item.id,
                "parent": parentId,
                "text": item.title,
                "li_attr": {
                    "title": item.title
                },
                "type": TREE_NODE_TYPE_FOLDER
            };
            g_FolderTree.appendNode(parentId, node, curToken);
            g_FolderTree.jstree.open_all();
        });
    }

    /**
     * [refreshContentTree description]
     * @param  {[String]} folderId form google drive folder ID.
     */
    function refreshContentTree(folderId) {
        g_ContentTree.clear();
            var curToken = g_ContentTree.generateToken();

            g_GoogleDrive.getFiles(folderId, function(item) {
                var node = {"id": item.id, "parent": "#", "text": item.title};

                // append node type
                if (item.mimeType == "application/vnd.google-apps.folder") {
                    node.type = TREE_NODE_TYPE_FOLDER;
                } else {
                    node.type = TREE_NODE_TYPE_LINK;
                    node.icon = item.iconLink;
                }

                g_ContentTree.appendNode("#", node, curToken);
            });
    }

    /**
     * Called when the client library is loaded to start the auth flow.
     */
    function handleClientLoad() {
        g_GoogleDrive.onAuthSuccess = function() {
            authSuccess();
        };
        g_GoogleDrive.onAuthFail = function() {
            handleClientLoadFailed();
        }

        g_GoogleDrive.auth(false);
    }

    /**
     * [handleClientLoadFailed description]
     * @return {[type]} [description]
     */
    function handleClientLoadFailed() {
        g_GoogleDrive.onAuthFail = function() {
            alert("auth failed");
        }

        $("#loginBtn").attr('disabled', false).click(function() {
            g_GoogleDrive.auth(true);
        });
    }

    /**
     * Auth success action.
     */
    function authSuccess() {
        // login button invisible
        $("#loginBtn").hide();

        // Access token has been successfully retrieved, requests can be sent to the API.
        g_GoogleDrive.getRootFolders(function(item) {
            $("#pageSelect").append($("<option></option>").attr("value", item.id).text(item.title));
        }); 
    }  

</script>

<script type="text/javascript" src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
<link rel="stylesheet" type="text/css" href="./libs/jtree/themes/default/style.min.css" />

<link rel="stylesheet" href="https://code.jquery.com/ui/1.11.1/themes/redmond/jquery-ui.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
</head>

<body>
<!-- header -->
<header>
    <h1>Bookmark This Way</h1>
</header>    

<div>
    <button title="qq" id="loginBtn" class="btn btn-danger" disabled>
        <i class="fa fa-google-plus-square fa-2x" style="vertical-align:middle"></i> Login
    </button>
</div>

<div class="row" style="margin: 20px 0px;"> 
    <section class="col-xs-2"> 
        <select id="pageSelect" class="form-control">
            <option value="">choose root folder...</option>
        </select>
    </section>
</div>

<div class="row">
    <div id="folderTree" class="col-md-4"></div>

    <div id="contentTree" class="col-md-4"></div>
</div>

</body>
</html>